<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Ria Busana</title>
    
    <!-- Favicon & Fonts -->
    <link rel="shortcut icon" href="./assets/icons/favicon.png" type="image/x-icon" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    
    <!-- CSS Utama & Icons -->
    <link rel="stylesheet" href="./dist/css/style.css" />
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet" />
    
    <style>
        /* Style Khusus Admin */
        body { background-color: #f4f6f9; }
        
        .login-wrapper {
            min-height: 80vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        .admin-dashboard {
            display: none; /* Hidden by default */
            padding: 50px 0;
            min-height: 80vh;
        }
        .review-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border-left: 5px solid #ddd;
            transition: all 0.3s;
        }
        .review-item.replied {
            border-left-color: rebeccapurple;
        }
        .review-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: 600;
            flex-wrap: wrap;
            gap: 10px;
        }
        .review-date {
            font-size: 12px;
            color: #888;
            font-weight: 400;
        }
        .review-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .btn-action {
            padding: 8px 15px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
            color: white;
        }
        .btn-reply { background: rebeccapurple; }
        .btn-reply:hover { background: #5a2d82; }
        .btn-delete { background: #ff4d4d; }
        .btn-delete:hover { background: #cc0000; }
        
        .reply-box {
            margin-top: 15px;
            display: none;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        .reply-box textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
            font-family: 'Poppins', sans-serif;
        }
        .status-badge {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 20px;
            background: #eee;
            color: #555;
            margin-left: 5px;
        }
        .status-badge.replied {
            background: #d1e7dd;
            color: #0f5132;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .stat-card i {
            font-size: 32px;
            padding: 18px;
            border-radius: 50%;
            color: white;
        }
        .stat-card .info h3 {
            font-size: 28px;
            font-weight: 700;
            margin: 0;
        }
        .stat-card .info p {
            font-size: 14px;
            color: #888;
            margin: 0;
        }
        .total-visitors i { background: #17a2b8; }
        .daily-visitors i { background: #28a745; }
        .total-days i { background: #ffc107; }
    </style>
</head>
<body>
    <!-- Navbar Admin -->
    <div class="navbar" style="background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
        <div class="container">
            <div class="navbar-box">
                <div class="logo">
                    <img src="./assets/icons/favicon.png" alt="RB Logo" />
                    <h1 style="color: rebeccapurple;">Admin Panel</h1>
                </div>
                <ul class="menu">
                    <li><a href="index.html" target="_blank">Lihat Website</a></li>
                    <li><a href="#" id="btn-logout" style="display: none; color: #ff4d4d; font-weight: bold;">Logout</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Login Section -->
    <div id="login-section" class="login-wrapper">
        <div class="login-box">
            <h2 style="margin-bottom: 20px; color: rebeccapurple;">Login Admin</h2>
            <div class="input-group">
                <input type="password" id="admin-password" placeholder="Masukkan Password..." style="text-align: center;">
            </div>
            <button id="btn-login" class="btn-kirim">Masuk</button>
            <p id="login-error" style="color: red; margin-top: 10px; display: none;">Password salah!</p>
        </div>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboard-section" class="admin-dashboard">
        <div class="container">
            <!-- Statistik Pengunjung -->
            <div class="stats-grid">
                <div class="stat-card total-visitors">
                    <i class="ri-team-fill"></i>
                    <div class="info">
                        <h3 id="total-visitors-stat">...</h3>
                        <p>Total Pengunjung</p>
                    </div>
                </div>
                <div class="stat-card daily-visitors">
                    <i class="ri-user-follow-fill"></i>
                    <div class="info">
                        <h3 id="daily-visitors-stat">...</h3>
                        <p>Pengunjung Hari Ini</p>
                    </div>
                </div>
                <div class="stat-card total-days">
                    <i class="ri-calendar-check-fill"></i>
                    <div class="info">
                        <h3 id="total-days-stat">...</h3>
                        <p>Total Hari Dilacak</p>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2>Daftar Ulasan Pelanggan</h2>
                <button id="refresh-btn" class="btn-action btn-reply"><i class="ri-refresh-line"></i> Refresh Data</button>
            </div>
            <div id="admin-reviews-container">
                <p style="text-align: center;">Memuat data...</p>
            </div>
        </div>
    </div>

    <!-- Script Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy, doc, updateDoc, deleteDoc, getDoc, addDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBsqB9ojiGqt4Ljgm67nWw8LTTw2Mnb4Pk",
            authDomain: "katalog-fashion.firebaseapp.com",
            projectId: "katalog-fashion",
            storageBucket: "katalog-fashion.appspot.com",
            messagingSenderId: "609453685879",
            appId: "1:609453685879:web:f771120f1034a765265a72"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- LOGIN LOGIC ---
        const loginSection = document.getElementById('login-section');
        const dashboardSection = document.getElementById('dashboard-section');
        const btnLogin = document.getElementById('btn-login');
        const passwordInput = document.getElementById('admin-password');
        const loginError = document.getElementById('login-error');
        const btnLogout = document.getElementById('btn-logout');

        btnLogin.addEventListener('click', () => {
            const pass = passwordInput.value;
            // PASSWORD ADMIN (Bisa diganti di sini)
            if (pass === 'admin123') { 
                sessionStorage.setItem('admin_logged_in', 'true');
                showDashboard();
            } else {
                loginError.style.display = 'block';
            }
        });

        btnLogout.addEventListener('click', (e) => {
            e.preventDefault();
            if(confirm("Yakin ingin logout?")) {
                sessionStorage.removeItem('admin_logged_in');
                location.reload();
            }
        });

        function showDashboard() {
            loginSection.style.display = 'none';
            dashboardSection.style.display = 'block';
            btnLogout.style.display = 'block';
            loadReviews();
            loadStats();
        }

        // --- DASHBOARD LOGIC ---
        const reviewsContainer = document.getElementById('admin-reviews-container');
        const refreshBtn = document.getElementById('refresh-btn');

        refreshBtn.addEventListener('click', loadReviews);

        async function loadStats() {
            const totalVisitorsEl = document.getElementById('total-visitors-stat');
            const dailyVisitorsEl = document.getElementById('daily-visitors-stat');
            const totalDaysEl = document.getElementById('total-days-stat');

            try {
                const visitorRef = doc(db, "stats", "visitors");
                const visitorDoc = await getDoc(visitorRef);

                if (visitorDoc.exists()) {
                    const data = visitorDoc.data();
                    const today = new Date().toISOString().split('T')[0];
                    
                    totalVisitorsEl.innerText = data.total_count || 0;
                    dailyVisitorsEl.innerText = data.daily_counts?.[today] || 0;
                    totalDaysEl.innerText = Object.keys(data.daily_counts || {}).length;
                } else {
                    totalVisitorsEl.innerText = '0';
                    dailyVisitorsEl.innerText = '0';
                    totalDaysEl.innerText = '0';
                }
            } catch (error) {
                console.error("Error loading stats:", error);
                totalVisitorsEl.innerText = 'N/A';
                dailyVisitorsEl.innerText = 'N/A';
                totalDaysEl.innerText = 'N/A';
            }
        }

        async function loadReviews() {
            reviewsContainer.innerHTML = '<p style="text-align: center;">Memuat data...</p>';
            try {
                const q = query(collection(db, "ulasan"), orderBy("tanggal", "desc"));
                const querySnapshot = await getDocs(q);
                
                reviewsContainer.innerHTML = '';
                
                if (querySnapshot.empty) {
                    reviewsContainer.innerHTML = '<p style="text-align: center;">Belum ada ulasan.</p>';
                    return;
                }

                querySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const id = docSnap.id;
                    const dateString = data.tanggal && data.tanggal.toDate ? data.tanggal.toDate().toLocaleDateString("id-ID") : "-";
                    const isReplied = data.balasan ? true : false;

                    const div = document.createElement('div');
                    div.className = `review-item ${isReplied ? 'replied' : ''}`;
                    div.innerHTML = `
                        <div class="review-header">
                            <span>${data.nama} <span class="status-badge ${isReplied ? 'replied' : ''}">${isReplied ? 'Sudah Dibalas' : 'Belum Dibalas'}</span></span>
                            <span class="review-date">${dateString}</span>
                        </div>
                        <div style="margin-bottom: 10px; color: #f39c12;">${'‚≠ê'.repeat(data.rating)}</div>
                        <p style="color: #555;">"${data.komentar}"</p>
                        
                        ${isReplied ? `<div style="margin-top: 10px; padding: 10px; background: #f1f1f1; border-radius: 5px; font-size: 14px; border-left: 3px solid rebeccapurple;"><strong>Admin:</strong> ${data.balasan}</div>` : ''}

                        <div class="review-actions">
                            <button class="btn-action btn-delete" onclick="deleteReview('${id}')"><i class="ri-delete-bin-line"></i> Hapus</button>
                            <button class="btn-action btn-reply" onclick="toggleReply('${id}')"><i class="ri-reply-line"></i> ${isReplied ? 'Edit Balasan' : 'Balas'}</button>
                        </div>

                        <div id="reply-box-${id}" class="reply-box">
                            <textarea id="reply-text-${id}" rows="3" placeholder="Tulis balasan admin...">${data.balasan || ''}</textarea>
                            <button class="btn-action btn-reply" onclick="sendReply('${id}')">Kirim Balasan</button>
                        </div>
                    `;
                    reviewsContainer.appendChild(div);
                });

            } catch (error) {
                console.error("Error:", error);
                reviewsContainer.innerHTML = '<p style="text-align: center; color: red;">Gagal memuat data. Cek koneksi internet.</p>';
            }
        }

        // Expose functions to window (agar bisa dipanggil onclick di HTML)
        window.toggleReply = (id) => {
            const box = document.getElementById(`reply-box-${id}`);
            box.style.display = box.style.display === 'block' ? 'none' : 'block';
        };

        window.sendReply = async (id) => {
            const text = document.getElementById(`reply-text-${id}`).value;
            if (!text) return alert("Balasan tidak boleh kosong!");

            const btn = document.querySelector(`#reply-box-${id} button`);
            const originalText = btn.innerText;
            btn.innerText = "Mengirim...";
            btn.disabled = true;

            try {
                await updateDoc(doc(db, "ulasan", id), {
                    balasan: text
                });
                alert("Balasan berhasil dikirim!");
                loadReviews(); // Refresh list
            } catch (e) {
                console.error(e);
                alert("Gagal mengirim balasan.");
                btn.innerText = originalText;
                btn.disabled = false;
            }
        };

        window.deleteReview = async (id) => {
            if (confirm("Yakin ingin menghapus ulasan ini secara permanen?")) {
                try {
                    await deleteDoc(doc(db, "ulasan", id));
                    alert("Ulasan dihapus.");
                    loadReviews();
                } catch (e) {
                    console.error(e);
                    alert("Gagal menghapus.");
                }
            }
        };

        // Cek apakah sudah login sebelumnya (Session Storage) - PINDAHKAN KE SINI
        if (sessionStorage.getItem('admin_logged_in') === 'true') {
            showDashboard();
        }
    </script>
</body>
</html>